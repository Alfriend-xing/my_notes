# Accessing data with MySQL

使用Spring Data JPA访问mysql


 #|#
--|--
路径|`mkdir -p src/main/java/hello`
依赖|`spring-boot-starter-web` `spring-boot-starter-data-jpa` `mysql-connector-java` `spring-boot-starter-test`


## 创建数据库

```shell
$ sudo mysql --password
```

```sql
mysql> create database db_example; -- Create the new database
mysql> create user 'springuser'@'%' identified by 'ThePassword'; -- Creates the user
mysql> grant all on db_example.* to 'springuser'@'%'; -- Gives all the privileges to the new user on the newly created database
```

## 配置文件

之前的例子使用自带的h2数据库，所以不需要配置文件

`src/main/resources/application.properties`

```properties
spring.jpa.hibernate.ddl-auto=update
spring.datasource.url=jdbc:mysql://${MYSQL_HOST:localhost}:3306/db_example
spring.datasource.username=springuser
spring.datasource.password=ThePassword
```
- spring.jpa.hibernate.ddl-auto字段可以是none, update, create, create-drop
  - none 是mysql的默认设置，不会更改数据结构
  - update Hibernate根据给定的Entity结构更改数据库。
  - create 每次创建数据库，但关闭时不删除
  - create-drop 创建数据库，当SessionFactory关闭时删除数据库
- 我们这里使用create 或 update，因为此时数据库还没有结构
- 首次运行之后可以改为update 或 none，当你想改变数据结构时使用update
- h2的默认值是create-drop，但没mysql的默认值是none

## 实体模型

用于表示数据库中的一行数据

`src/main/java/hello/User.java`

```java
package hello;

import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;

@Entity // This tells Hibernate to make a table out of this class
public class User {
    @Id
    @GeneratedValue(strategy=GenerationType.AUTO)
    private Integer id;

    private String name;

    private String email;

	public Integer getId() {
		return id;
	}

	public void setId(Integer id) {
		this.id = id;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public String getEmail() {
		return email;
	}

	public void setEmail(String email) {
		this.email = email;
	}


}
```

## 数据仓库

为上述实体创建操作接口，继承于CrudRepository接口，spring会自动实现其中的功能

`src/main/java/hello/UserRepository.java`

```java
package hello;

import org.springframework.data.repository.CrudRepository;

import hello.User;

// This will be AUTO IMPLEMENTED by Spring into a Bean called userRepository
// CRUD refers Create, Read, Update, Delete

public interface UserRepository extends CrudRepository<User, Integer> {

}
```

## 控制器

`src/main/java/hello/MainController.java`

```java
package hello;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

@Controller    // This means that this class is a Controller
@RequestMapping(path="/demo") // This means URL's start with /demo (after Application path)
public class MainController {
	@Autowired // This means to get the bean called userRepository
	           // Which is auto-generated by Spring, we will use it to handle the data
	private UserRepository userRepository;
 
	@PostMapping(path="/add") // Map ONLY POST Requests
	public @ResponseBody String addNewUser (@RequestParam String name
			, @RequestParam String email) {
		// @ResponseBody means the returned String is the response, not a view name
		// @RequestParam means it is a parameter from the GET or POST request

		User n = new User();
		n.setName(name);
		n.setEmail(email);
		userRepository.save(n);
		return "Saved";
	}

	@GetMapping(path="/all")
	public @ResponseBody Iterable<User> getAllUsers() {
		// This returns a JSON or XML with the users
		return userRepository.findAll();
	}
}
```

## 启动

`src/main/java/hello/Application.java`

```java
package hello;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```
- ./mvnw spring-boot:run
- ./mvnw clean package
- java -jar target/gs-accessing-data-mysql-0.1.0.jar

## 测试

```shell
$ curl localhost:8080/demo/add -d name=First -d email=someemail@someemailprovider.com
# 返回
Saved

$ curl 'localhost:8080/demo/all'
# 返回
[{"id":1,"name":"First","email":"someemail@someemailprovider.com"}]
```

## 安全设置

适用于生产环境

```sql
# 收回用户的所有权限
mysql> revoke all on db_example.* from 'springuser'@'localhost';
# 赋予权限只能修改数据而不能改变表结构
mysql> grant select, insert, delete, update on db_example.* to 'springuser'@'localhost';
```
要在现有数据库上做安全配置，先按上述修改权限，之后将配置文件中spring.jpa.hibernate.ddl-auto 设为 update，重启程序。




